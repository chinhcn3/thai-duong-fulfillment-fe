{
    "taskRoleArn": "ecsTaskRole-${APP_NAME}",
    "executionRoleArn": "ecsTaskExecutionRole-${APP_NAME}",
    "volumes": [],
    "family": "${APP_NAME}_${ENVIRONMENT}",
    "cpu": "${RESERVED_CPU_UNIT}",
    "memory": "${RESERVED_MEMORY}",
    "networkMode": "awsvpc",
    "placementConstraints": [],
    "requiresCompatibilities": [
        "FARGATE"
    ],
    "containerDefinitions": [
      {
        "disableNetworking": false,
        "name": "${APP_NAME}",
        "image": "${ECR_AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${APP_NAME}:${ENVIRONMENT}_${CIRCLE_SHA1}",
        "essential": true,
        "command": [
            "yarn",
            "start"
        ],
        "portMappings": [
          {
            "containerPort": 3000,
            "hostPort": 3000,
            "protocol": "tcp"
          }
        ],
        "logConfiguration": {
          "logDriver": "awsfirelens",
          "options": {
            "Name": "datadog",
            "dd_service": "${APP_NAME}_${ENVIRONMENT}",
            "dd_source": "${ECS_SERVICE}",
            "dd_tags": "project:${APP_NAME}_${ENVIRONMENT}",
            "TLS": "on",
            "provider": "ecs"
          },
          "secretOptions": [
            {
              "name": "apiKey",
              "valueFrom": "/${ECS_SERVICE}/${ENVIRONMENT}/DD_API_KEY"
            }
          ]
        },
        "dockerLabels": {
          "com.datadoghq.ad.instances": "[{\"host\": \"%%host%%\", \"port\": \"3000\"}]",
          "com.datadoghq.ad.check_names": "[\"${APP_NAME}\"]",
          "com.datadoghq.ad.init_configs": "[{}]"
        }
      },
      {
        "name": "log_router",
        "image": "906394416424.dkr.ecr.ap-northeast-1.amazonaws.com/aws-for-fluent-bit:2.8.0",
        "essential": true,
        "firelensConfiguration": {
          "type": "fluentbit",
          "options": {
            "enable-ecs-log-metadata": "true"
          }
        }
      },
      {
        "name": "datadog-agent",
        "image": "datadog/agent:latest",
        "essential": true,
        "environment": [
          {
            "name": "ECS_FARGATE",
            "value": "true"
          },
          {
            "name": "DD_APM_ENABLED",
            "value": "${DD_APM_ENABLED}"
          },
          {
            "name": "DD_LOGS_ENABLED",
            "value": "${DD_LOGS_ENABLED}"
          }
        ],
        "secrets": [
          {
            "name": "DD_API_KEY",
            "valueFrom": "/${ECS_SERVICE}/${ENVIRONMENT}/DD_API_KEY"
          }
        ]
      }
    ]
  }